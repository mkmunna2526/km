<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Momte</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #4A90E2 0%, #D81B60 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: #ffffff;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 25px rgba(0,0,0,0.15);
            border-radius: 15px 15px 0 0;
        }

        .header {
            background: linear-gradient(135deg, #4A90E2, #D81B60);
            color: white;
            padding: 15px 25px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .header .logo {
            width: 35px;
            height: 35px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin: 0;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 800;
            margin: 0;
            display: block;
        }

        .header .user-info {
            background: rgba(255,255,255,0.15);
            margin: 0;
            padding: 8px 15px;
            display: block;
            font-size: 13px;
            font-weight: 600;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .main-content {
            padding: 25px;
            padding-bottom: 90px;
        }

        .products-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-bottom: 35px;
        }

        .product-card {
            background: #ffffff;
            border-radius: 18px;
            padding: 18px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #ffffff 70%, #E6F0FA 100%);
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 10px 30px rgba(74,144,226,0.2);
            border-color: #4A90E2;
        }

        .product-icon {
            width: 65px;
            height: 65px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 34px;
            border-radius: 14px;
            background: linear-gradient(135deg, #D81B60, #4A90E2);
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .product-price {
            font-size: 20px;
            font-weight: 700;
            color: #D81B60;
            margin-bottom: 8px;
            text-align: center;
            text-transform: uppercase;
        }

        .product-stock {
            font-size: 13px;
            color: #666;
            text-align: center;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .buy-btn {
            width: 100%;
            background: linear-gradient(135deg, #4A90E2, #D81B60);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s ease;
            font-size: 14px;
            text-transform: uppercase;
        }

        .buy-btn:hover {
            transform: scale(1.07);
            box-shadow: 0 6px 20px rgba(74,144,226,0.4);
        }

        .collect-btn {
            background: linear-gradient(135deg, #10B981, #059669);
        }

        .free-products {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px dashed #E6F0FA;
        }

        .free-title {
            text-align: center;
            font-size: 20px;
            font-weight: 800;
            color: #10B981;
            margin-bottom: 18px;
            text-transform: uppercase;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 420px;
            background: white;
            padding: 15px;
            box-shadow: 0 -6px 25px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-around;
            z-index: 1000;
            border-top: 1px solid #E6F0FA;
        }

        .nav-btn {
            background: linear-gradient(135deg, #4A90E2, #D81B60);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s ease;
            flex: 1;
            margin: 0 8px;
            text-transform: uppercase;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(74,144,226,0.4);
        }

        .account-section {
            display: none;
            padding: 25px;
        }

        .balance-card {
            background: linear-gradient(135deg, #4A90E2, #D81B60);
            color: white;
            padding: 20px;
            border-radius: 18px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .balance-amount {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .tasks-section {
            background: #ffffff;
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .tasks-title {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 18px;
            color: #333;
            text-transform: uppercase;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #E6F0FA;
        }

        .task-info {
            flex: 1;
        }

        .task-title {
            font-weight: 700;
            margin-bottom: 6px;
        }

        .task-reward {
            font-size: 15px;
            color: #10B981;
            font-weight: 700;
        }

        .task-btn {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s ease;
        }

        .task-btn.completed {
            background: #10B981;
        }

        .task-btn.confirmed {
            background: #FBBF24;
            cursor: not-allowed;
        }

        .task-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .task-btn:hover {
            transform: scale(1.07);
        }

        .referral-section {
            margin-top: 25px;
            background: #ffffff;
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            display: block;
        }

        .referral-link {
            background: #F5F7FA;
            padding: 12px;
            border-radius: 10px;
            word-break: break-all;
            margin-bottom: 12px;
            font-family: monospace;
            color: #333;
        }

        .share-btn {
            width: 100%;
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
        }

        .purchased-section {
            display: none;
            padding: 25px;
        }

        .purchased-item {
            background: #ffffff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #4A90E2;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #ffffff;
            padding: 35px;
            border-radius: 18px;
            text-align: center;
            max-width: 320px;
            margin: 0 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.06); }
            100% { transform: scale(1); }
        }

        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 4px solid #F3F3F3;
            border-top: 4px solid #4A90E2;
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10B981;
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.4s ease;
            z-index: 3000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .telegram-id-display {
            background: rgba(255,255,255,0.1);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            opacity: 0.9;
            margin-top: 3px;
        }

        .wallet-connect-btn {
            background: linear-gradient(135deg, #0088CC, #005580);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo"></div>
            <h1>MOMTE</h1>
            <div class="user-info" id="userInfo">
                <span id="userName">Guest User</span>
                <div class="telegram-id-display" id="telegramIdDisplay" style="display: none;">
                    ID: <span id="telegramIdSpan">000000</span>
                </div>
            </div>
        </div>

        <div class="main-content" id="homeSection">
            <div class="products-grid">
                <div class="product-card pulse" onclick="buyProduct('watch', 1.5, 'watch-sold', '‚åö Smart Watch')">
                    <div class="product-icon">‚åö</div>
                    <div class="product-price">1.5 TON</div>
                    <div class="product-stock">Stock: <span id="watch-sold">0</span>/<span id="watch-total">50000</span></div>
                    <button class="buy-btn">Buy Now</button>
                </div>

                <div class="product-card pulse" onclick="buyProduct('key', 3, 'headphones-sold', 'üîë Premium Key')">
                    <div class="product-icon">üîë</div>
                    <div class="product-price">3 TON</div>
                    <div class="product-stock">Stock: <span id="headphones-sold">0</span>/<span id="headphones-total">5000</span></div>
                    <button class="buy-btn">Buy Now</button>
                </div>

                <div class="product-card pulse" onclick="buyProduct('headphones', 0.9, 'earphones-sold', 'üéß Wireless Headphones')">
                    <div class="product-icon">üéß</div>
                    <div class="product-price">0.9 TON</div>
                    <div class="product-stock">Stock: <span id="earphones-sold">0</span>/<span id="earphones-total">100000</span></div>
                    <button class="buy-btn">Buy Now</button>
                </div>

                <div class="product-card pulse" onclick="buyProduct('phone', 16, 'phone-sold', 'üì± Smartphone')">
                    <div class="product-icon">üì±</div>
                    <div class="product-price">16 TON</div>
                    <div class="product-stock">Stock: <span id="phone-sold">0</span>/<span id="phone-total">5000</span></div>
                    <button class="buy-btn">Buy Now</button>
                </div>

                <div class="product-card pulse" onclick="buyProduct('diamond', 2.5, 'diamond-sold', 'üíé Premium Diamond')">
                    <div class="product-icon">üíé</div>
                    <div class="product-price">2.5 TON</div>
                    <div class="product-stock">Stock: <span id="diamond-sold">0</span>/<span id="diamond-total">5000</span></div>
                    <button class="buy-btn">Buy Now</button>
                </div>

                <div class="product-card pulse" onclick="buyProduct('game', 0.8, 'game-sold', 'üéÆ Gaming Console')">
                    <div class="product-icon">üéÆ</div>
                    <div class="product-price">0.8 TON</div>
                    <div class="product-stock">Stock: <span id="game-sold">0</span>/<span id="game-total">5000</span></div>
                    <button class="buy-btn">Buy Now</button>
                </div>

                <div class="product-card pulse" onclick="buyProduct('bag', 0.6, 'bag-sold', 'üéí Premium Backpack')">
                    <div class="product-icon">üéí</div>
                    <div class="product-price">0.6 TON</div>
                    <div class="product-stock">Stock: <span id="bag-sold">0</span>/<span id="bag-total">5000</span></div>
                    <button class="buy-btn">Buy Now</button>
                </div>
            </div>

            <div class="free-products">
                <div class="free-title">üéÅ Free Rewards</div>
                <div class="products-grid">
                    <div class="product-card">
                        <div class="product-icon">üéÅ</div>
                        <div class="product-price">FREE</div>
                        <div class="product-stock">Available: <span id="gift1-available">1000000</span></div>
                        <button class="buy-btn collect-btn" onclick="collectFree('gift1', 10, 'gift1-available')">Collect Now</button>
                    </div>

                    <div class="product-card">
                        <div class="product-icon">üèÜ</div>
                        <div class="product-price">FREE</div>
                        <div class="product-stock">Available: <span id="gift2-available">2000000</span></div>
                        <button class="buy-btn collect-btn" onclick="collectFree('gift2', 25, 'gift2-available')">Collect Now</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="account-section" id="accountSection">
            <div class="balance-card">
                <div class="balance-amount" id="userBalance">0</div>
                <div>Points Balance</div>
            </div>

            <div class="tasks-section">
                <div class="tasks-title">Complete Tasks</div>
                <div class="task-item">
                    <div class="task-info">
                        <div class="task-title">Subscribe YouTube Channel</div>
                        <div class="task-reward">+500 Points</div>
                    </div>
                    <button class="task-btn" id="youtubeTask" onclick="completeTask('youtube', 500, 'https://www.youtube.com/channel/UCc7dtnWf2U8mQP0XDpocxCQ')">Start</button>
                </div>
                <div class="task-item">
                    <div class="task-info">
                        <div class="task-title">Follow Telegram Channel</div>
                        <div class="task-reward">+30 Points</div>
                    </div>
                    <button class="task-btn" id="telegramTask" onclick="completeTask('telegram', 30, 'https://t.me/MOMTECOMMUNITY')">Start</button>
                </div>
                <div class="task-item">
                    <div class="task-info">
                        <div class="task-title">Join Telegram Bot</div>
                        <div class="task-reward">+40 Points</div>
                    </div>
                    <button class="task-btn" id="botTask" onclick="completeTask('bot', 40, 'https://t.me/jejbduiwjdbuejbot')">Start</button>
                </div>
            </div>

            <div class="referral-section">
                <div class="tasks-title">Referral Program</div>
                <p style="margin-bottom: 10px;">Share your referral link and earn 1 point per friend (up to 50)</p>
                <div class="referral-link" id="referralLink">@yourmomtebot?start=ref_0</div>
                <div style="margin-bottom: 10px;">Referrals: <span id="referralCount">0</span>/50</div>
                <button class="share-btn" onclick="shareReferral()">Share Now</button>
            </div>
        </div>

        <div class="purchased-section" id="purchasedSection">
            <h2 style="margin-bottom: 20px;">My Purchases</h2>
            <h5 style="margin-bottom: 10px;">üîî Important Notice ‚Äì Product Purchase, Token Conversion & Redemption When you purchase a product using TON, it will be automatically added to your collection. After refreshing, the item will disappear from view ‚Äî this means it has been securely stored and is eligible for future real-world redemption. Only products purchased with TON are valid. After our platform is officially listed, payment must be completed using the same TON wallet address originally used. No other method will be accepted. Your points balance (shown in tasks) will reset after each login, because those points are automatically converted into crypto (future utility tokens). After listing, you will be notified exactly how many tokens you've earned based on your activity. Real products will be redeemable in future using your verified TON wallet. Start collecting now ‚Äî your rewards are real and your wallet is your key!üîó Stay updated: Follow our official Telegram channel @MOMTECOMMUNITY</h5>
            <div id="purchasedItems">
                <div class="purchased-item">
                    <p>No purchases yet. Buy some products to see them here!</p>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-btn" onclick="showSection('home')">Home</button>
            <button class="nav-btn" onclick="showSection('account')">Account</button>
            <button class="nav-btn" onclick="showSection('purchased')">My Items</button>
        </div>
    </div>

    <div class="modal" id="purchaseModal">
        <div class="modal-content">
            <h3>Opening TonKeeper Wallet...</h3>
            <div class="loading" style="margin: 20px 0;"></div>
            <p>Please complete your payment in TonKeeper</p>
            <button onclick="closePurchaseModal()" style="margin-top: 15px; padding: 8px 16px; background: #4A90E2; color: white; border: none; border-radius: 8px; cursor: pointer;">Close</button>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        let userBalance = 0;
        let purchasedItems = [];
        let currentSection = 'home';
        let completedTasks = {};
        let referralCount = 0;
        let stockCounts = {};
        let telegramId = null;
        let userName = 'Guest User';

        const TON_ADDRESS = 'UQDpNcFB_W9VsD-loC8c1ShuE0xFEzjkwzKiF2fGBfkZ6FJJ';
        const API_URL = 'https://ashraful.munnacodsit.xyz/app/telegram.php';

        // TonKeeper deep link function
        function createTonKeeperLink(recipient, amount, message) {
            // Convert TON to nanoTON (1 TON = 1,000,000,000 nanoTON)
            const nanoAmount = Math.floor(amount * 1000000000);
            
            // Create the TonKeeper deep link
            const tonKeeperLink = `https://app.tonkeeper.com/transfer/${recipient}?amount=${nanoAmount}&text=${encodeURIComponent(message)}`;
            
            return tonKeeperLink;
        }

        // Initialize app
        async function initApp() {
            console.log('Initializing app...');
            
            if (window.Telegram && window.Telegram.WebApp) {
                try {
                    window.Telegram.WebApp.ready();
                    const user = window.Telegram.WebApp.initDataUnsafe?.user;
                    
                    if (user) {
                        telegramId = user.id;
                        userName = user.first_name || user.username || 'User';
                        
                        // Update UI with user info
                        document.getElementById('userName').textContent = userName;
                        document.getElementById('telegramIdSpan').textContent = telegramId;
                        document.getElementById('telegramIdDisplay').style.display = 'block';
                        document.getElementById('userInfo').style.display = 'block';
                        document.getElementById('referralLink').textContent = `@yourmomtebot?start=ref_${telegramId}`;
                        
                        // Sign up user
                        await signupUser(telegramId, userName);
                        await loadUserData();
                        
                        showNotification(`Welcome ${userName}! ID: ${telegramId}`);
                    } else {
                        showNotification('Please open this app through Telegram');
                    }
                } catch (error) {
                    console.error('Telegram initialization error:', error);
                    showNotification('Error initializing Telegram connection');
                }
            } else {
                showNotification('This app works best in Telegram');
            }
            
            updateUI();
        }

        // Sign up user
        async function signupUser(telegramId, username) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `action=signup&telegram_id=${telegramId}&username=${encodeURIComponent(username)}`
                });
                const data = await response.json();
                if (!data.success) {
                    console.error('Signup error:', data.message);
                }
            } catch (e) {
                console.error('Network error during signup:', e);
            }
        }

        // Show section
        function showSection(section) {
            document.getElementById('homeSection').style.display = 'none';
            document.getElementById('accountSection').style.display = 'none';
            document.getElementById('purchasedSection').style.display = 'none';

            if (section === 'home') {
                document.getElementById('homeSection').style.display = 'block';
            } else if (section === 'account') {
                document.getElementById('accountSection').style.display = 'block';
            } else if (section === 'purchased') {
                document.getElementById('purchasedSection').style.display = 'block';
                updatePurchasedItems();
            }

            currentSection = section;
        }

        // Buy product with enhanced TonKeeper integration
        async function buyProduct(productName, price, stockId, productDisplayName) {
            if (!telegramId) {
                showNotification('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá Telegram ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!');
                return;
            }

            try {
                // Show processing modal
                document.getElementById('purchaseModal').style.display = 'flex';
                
                // Create purchase message with user info
                const purchaseMessage = `Momte_${productName}_${Date.now()}_${telegramId}_${userName}`;
                
                // Create TonKeeper links
                const { tonKeeperLink, tonProtocolLink, nanoAmount } = createTonKeeperLink(TON_ADDRESS, price, purchaseMessage);
                
                console.log('Opening TonKeeper with:', {
                    recipient: TON_ADDRESS,
                    amount: `${price} TON (${nanoAmount} nanoTON)`,
                    message: purchaseMessage
                });
                
                showNotification(`TonKeeper ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ${productDisplayName || productName} ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø...`);
                
                // Enhanced TonKeeper opening with multiple attempts
                setTimeout(() => {
                    let opened = false;
                    
                    // Try TonKeeper app link first
                    try {
                        if (window.Telegram && window.Telegram.WebApp) {
                            // In Telegram, use openLink
                            window.Telegram.WebApp.openLink(tonKeeperLink);
                        } else {
                            // In browser, use window.open
                            window.open(tonKeeperLink, '_blank');
                        }
                        opened = true;
                        showNotification('TonKeeper ‡¶è ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
                    } catch (error) {
                        console.log('TonKeeper app link failed, trying protocol link');
                        
                        // Try ton:// protocol
                        try {
                            window.location.href = tonProtocolLink;
                            opened = true;
                            showNotification('TonKeeper ‡¶è ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
                        } catch (protocolError) {
                            console.log('Protocol link also failed');
                        }
                    }
                    
                    if (!opened) {
                        // Final fallback: copy to clipboard
                        const fallbackText = `TonKeeper ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶Ç‡¶ï:\n${tonKeeperLink}\n\n‡¶Ö‡¶•‡¶¨‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü:\n‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: ${TON_ADDRESS}\n‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: ${price} TON\n‡¶Æ‡ßá‡¶∏‡ßá‡¶ú: ${purchaseMessage}`;
                        
                        if (navigator.clipboard) {
                            navigator.clipboard.writeText(fallbackText).then(() => {
                                showNotification('‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶•‡ßç‡¶Ø clipboard ‡¶è ‡¶ï‡¶™‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
                            });
                        } else {
                            showNotification('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá TonKeeper ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®');
                        }
                    }
                }, 1000);

                // Record purchase attempt in backend
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `action=buy_product&telegram_id=${telegramId}&product_name=${productName}&price=${price}&stock_id=${stockId}&message=${encodeURIComponent(purchaseMessage)}&ton_address=${TON_ADDRESS}`
                });
                
                const data = await response.json();
                if (data.success) {
                    // Add to purchased items
                    purchasedItems.push({
                        name: productDisplayName || productName,
                        price: price,
                        date: new Date().toLocaleString('bn-BD'),
                        status: 'pending',
                        message: purchaseMessage,
                        tonAddress: TON_ADDRESS
                    });
                    
                    // Update stock count
                    const stockElement = document.getElementById(stockId);
                    if (stockElement) {
                        const currentSold = parseInt(stockElement.textContent);
                        stockElement.textContent = currentSold + 1;
                    }
                    
                    updatePurchasedItems();
                    showNotification('‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! My Items ‡¶è ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§');
                } else {
                    showNotification('‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ' + (data.message || 'Purchase failed'));
                }
                
            } catch (error) {
                console.error('Purchase error:', error);
                showNotification('‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ‡¶Ø‡¶º ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
            }
        }

        // Close purchase modal
        function closePurchaseModal() {
            document.getElementById('purchaseModal').style.display = 'none';
        }

        // Collect free items
        function collectFree(itemName, points, availableId) {
            const availableElement = document.getElementById(availableId);
            const currentAvailable = parseInt(availableElement.textContent);

            if (currentAvailable > 0) {
                availableElement.textContent = currentAvailable - 1;
                const button = event.target;
                button.textContent = 'Confirmed';
                button.classList.add('confirmed');
                button.disabled = true;

                setTimeout(() => {
                    button.textContent = 'Completed';
                    button.classList.add('completed');
                    button.disabled = true;
                }, 2000);

                userBalance += points;
                updateUI();
                showNotification(`+${points} points collected!`);
            }
        }

        // Complete task
        async function completeTask(taskType, reward, link) {
            const button = document.getElementById(taskType + 'Task');
            if (button.classList.contains('confirmed') || button.classList.contains('completed')) {
                showNotification('Task already processed!');
                return;
            }

            if (!telegramId) {
                showNotification('Please login through Telegram first!');
                return;
            }

            button.textContent = 'Confirmed';
            button.classList.add('confirmed');
            button.disabled = true;
            
            // Open task link
            window.open(link, '_blank');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `action=complete_task&telegram_id=${telegramId}&task_type=${taskType}&reward=${reward}`
                });
                const data = await response.json();
                if (data.success) {
                    userBalance += reward;
                    completedTasks[taskType] = true;
                    button.textContent = 'Completed';
                    button.classList.add('completed');
                    showNotification(`+${reward} points earned!`);
                    updateUI();
                } else {
                    button.textContent = 'Start';
                    button.classList.remove('confirmed');
                    button.disabled = false;
                    showNotification('Error completing task: ' + data.message);
                }
            } catch (e) {
                button.textContent = 'Start';
                button.classList.remove('confirmed');
                button.disabled = false;
                showNotification('Error connecting to server');
            }
        }

        // Share referral
        function shareReferral() {
            if (!telegramId) {
                showNotification('Please login through Telegram first!');
                return;
            }

            const referralLink = `https://t.me/yourmomtebot?start=ref_${telegramId}`;
            const shareText = `üéÅ Join Momte and get exclusive digital products with TON cryptocurrency! üíé\n\nUse my referral link: ${referralLink}`;

            if (navigator.share) {
                navigator.share({
                    title: 'Join Momte - Digital Products with TON',
                    text: shareText,
                    url: referralLink
                }).then(() => {
                    showNotification('Referral link shared!');
                }).catch(() => {
                    copyToClipboard(shareText);
                });
            } else {
                copyToClipboard(shareText);
            }
        }

        // Copy to clipboard helper
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('Referral link copied to clipboard!');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification('Referral link copied to clipboard!');
                } catch (err) {
                    showNotification('Please copy the link manually');
                }
                document.body.removeChild(textArea);
            }
        }

        // Update purchased items display
        function updatePurchasedItems() {
            const container = document.getElementById('purchasedItems');

            if (purchasedItems.length === 0) {
                container.innerHTML = '<div class="purchased-item"><p>No purchases yet. Buy some products to see them here!</p></div>';
                return;
            }

            container.innerHTML = purchasedItems.map(item => `
                <div class="purchased-item">
                    <h4>${item.name}</h4>
                    <p>Price: ${item.price} TON</p>
                    <p>Date: ${item.date}</p>
                    <p>Status: <span style="color: ${item.status === 'approved' ? '#10B981' : item.status === 'pending' ? '#FBBF24' : '#DC2626'}; font-weight: 600; text-transform: uppercase;">${item.status}</span></p>
                    ${item.message ? `<p style="font-size: 12px; color: #666; font-family: monospace;">${item.message}</p>` : ''}
                </div>
            `).join('');
        }

        // Update UI
        function updateUI() {
            document.getElementById('userBalance').textContent = userBalance.toLocaleString();
            document.getElementById('referralCount').textContent = referralCount;

            // Update completed tasks
            for (let taskType of Object.keys(completedTasks)) {
                const button = document.getElementById(taskType + 'Task');
                if (button && completedTasks[taskType]) {
                    button.textContent = 'Completed';
                    button.classList.add('completed');
                    button.disabled = true;
                }
            }

            // Update stock counts
            for (let product of Object.keys(stockCounts)) {
                const soldElement = document.getElementById(product + '-sold');
                const totalElement = document.getElementById(product + '-total');
                if (soldElement && totalElement) {
                    soldElement.textContent = stockCounts[product].stock_sold || 0;
                    totalElement.textContent = stockCounts[product].stock_total || 0;
                }
            }
        }

        // Load user data
        async function loadUserData() {
            if (!telegramId) return;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `action=get_user_data&telegram_id=${telegramId}`
                });
                const data = await response.json();
                
                if (data.success) {
                    userBalance = data.balance || 0;
                    
                    // Load purchased items
                    if (data.purchased_items && Array.isArray(data.purchased_items)) {
                        purchasedItems = data.purchased_items.map(item => ({
                            name: item.product_name,
                            price: item.price,
                            date: new Date(item.purchase_date).toLocaleString(),
                            status: item.status || 'pending',
                            message: item.message || ''
                        }));
                    }
                    
                    // Load completed tasks
                    completedTasks = {};
                    if (data.completed_tasks && Array.isArray(data.completed_tasks)) {
                        data.completed_tasks.forEach(task => {
                            completedTasks[task] = true;
                        });
                    }
                    
                    referralCount = data.referral_count || 0;
                    
                    // Load stock counts
                    stockCounts = {};
                    if (data.stock_counts && Array.isArray(data.stock_counts)) {
                        data.stock_counts.forEach(stock => {
                            stockCounts[stock.product_id] = {
                                stock_sold: stock.stock_sold,
                                stock_total: stock.stock_total
                            };
                        });
                    }
                    
                    updateUI();
                } else {
                    console.error('Error loading user data:', data.message);
                }
            } catch (e) {
                console.error('Network error loading user data:', e);
            }
        }

        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', initApp);

        // Telegram WebApp event handlers
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.onEvent('mainButtonClicked', function() {
                console.log('Main button clicked');
            });
            
            window.Telegram.WebApp.onEvent('backButtonClicked', function() {
                if (currentSection !== 'home') {
                    showSection('home');
                } else {
                    window.Telegram.WebApp.close();
                }
            });
            
            // Expand the app
            window.Telegram.WebApp.expand();
            
            // Enable closing confirmation
            window.Telegram.WebApp.enableClosingConfirmation();
        }

        // Auto-refresh user data every 30 seconds
        setInterval(() => {
            if (telegramId) {
                loadUserData();
            }
        }, 30000);

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && telegramId) {
                loadUserData();
            }
        });

        // Handle errors globally
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showNotification('An error occurred. Please try again.');
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showNotification('Connection error. Please check your internet.');
        });

        console.log('Momte app initialized successfully');
    </script>
</body>
</html>
